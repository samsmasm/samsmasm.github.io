<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Griz - Trivia Board</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent-color: #0645ad;
            --text-color: #ffffff;
            --highlight-color: #f1c40f;
            --active-team-bg: #2ecc71;
            --wrong-color: #e74c3c;
            --modal-overlay: rgba(0, 0, 0, 0.95);
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }
        .container { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 10px; }

        /* --- SETUP VIEW --- */
        #setup-view {
            max-width: 900px;
            margin: 0 auto;
            height: 100%;
            width: 100%;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin-bottom: 10px; color: var(--highlight-color); text-transform: uppercase; font-size: 3rem; text-align: center; }
        
        .setup-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-bottom: 20px;
            background: #222;
            padding: 20px;
            border-radius: 8px;
        }

        .team-setup-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .team-setup-grid input {
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }

        textarea {
            width: 100%;
            flex: 1;
            min-height: 200px;
            background: #2a2a2a;
            color: #ddd;
            border: 2px solid #444;
            padding: 15px;
            font-family: monospace;
            border-radius: 8px;
            resize: none;
            margin-bottom: 20px;
        }
        textarea:focus { outline: none; border-color: var(--highlight-color); }

        .btn-group { display: flex; gap: 15px; width: 100%; justify-content: center; }
        button {
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--highlight-color); color: #000; }
        .btn-secondary { background-color: #444; color: #fff; }
        .btn-gpt { background-color: #10a37f; color: white; text-decoration: none; display: inline-block; text-align: center;}
        
        /* --- GAME VIEW --- */
        #game-view { height: 100vh; display: flex; flex-direction: column; }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #111;
        }

        /* Scoreboard */
        #scoreboard {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .team-card {
            background: #333;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid transparent;
            min-width: 120px;
            position: relative;
            transition: all 0.3s ease;
        }

        .team-card.active {
            background: #004d00;
            border-color: var(--active-team-bg);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
            transform: scale(1.05);
            z-index: 2;
        }

        .team-name { font-size: 0.9rem; color: #ccc; margin-bottom: 5px; font-weight: bold;}
        .team-points { font-size: 1.6rem; font-weight: bold; color: white; }
        
        .btn-manual-add {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #555;
            color: white;
            border-radius: 50%;
            font-size: 1rem;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .btn-manual-add:hover { background: var(--highlight-color); color: black; }

        .btn-reset { background: #c0392b; color: white; font-size: 0.9rem; padding: 8px 16px; }

        /* The Grid Board */
        #board-container {
            flex: 1;
            padding: 20px;
            overflow: hidden; /* No scroll on body */
        }
        
        #board {
            display: grid;
            /* Columns set by JS */
            gap: 15px;
            height: 100%;
            width: 100%;
        }

        .cat-header {
            background-color: var(--accent-color);
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            border: 2px solid #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-size: clamp(1rem, 2.5vh, 1.8rem); /* Responsive text */
        }

        .tile {
            background-color: var(--accent-color);
            color: var(--highlight-color);
            font-size: clamp(2rem, 5vh, 4rem);
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, background-color 0.2s;
            text-shadow: 2px 2px 0 #000;
        }

        .tile:hover {
            border-color: var(--highlight-color);
            background-color: #0856d6;
            z-index: 5;
        }

        .tile.used {
            background-color: #1a1a1a;
            color: transparent;
            text-shadow: none;
            cursor: default;
            border-color: #333;
            pointer-events: none;
        }

        /* --- MODALS --- */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: var(--modal-overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: var(--accent-color);
            border: 4px solid var(--highlight-color);
            width: 95%;
            max-width: 1100px;
            max-height: 95vh;
            padding: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 10px;
            overflow-y: auto;
            position: relative;
        }

        .active-team-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.4);
            color: var(--highlight-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            border: 1px solid var(--highlight-color);
        }

        .q-text {
            font-size: clamp(1.8rem, 4vw, 3rem);
            font-weight: bold;
            text-transform: uppercase;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            line-height: 1.3;
        }

        .media-container img, .media-container video { max-height: 45vh; max-width: 100%; border: 2px solid white; }

        .answer-box {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            width: 100%;
            font-size: 2rem;
            color: var(--highlight-color);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-controls { margin-top: 10px; display: flex; gap: 20px; justify-content: center;}
        
        .btn-close { position: absolute; top: 15px; right: 20px; background: transparent; color: #aaa; font-size: 2.5rem; padding: 0; }
        .btn-close:hover { color: white; }

        .btn-award { background-color: var(--active-team-bg); color: white; min-width: 150px;}
        .btn-wrong { background-color: var(--wrong-color); color: white; min-width: 150px;}

        /* --- WINNER MODAL (RAINBOW) --- */
        #winner-modal .modal-content {
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400%;
            animation: rainbow 20s linear infinite;
            border: 5px solid white;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .winner-text { font-size: 4rem; font-weight: 900; margin-bottom: 20px; }
        .winner-name { font-size: 5rem; color: white; text-decoration: underline; }

    </style>
</head>
<body>

    <div id="setup-view" class="container">
        <h1>Griz</h1>
        
        <div class="setup-controls">
            <div>
                <h3 style="margin-bottom: 10px; color:#aaa;">Settings</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color:white; margin-right: 10px;">Number of Teams:</label>
                    <select id="team-count" onchange="updateTeamInputs()">
                        <option value="1">1 Player</option>
                        <option value="2" selected>2 Teams</option>
                        <option value="3">3 Teams</option>
                        <option value="4">4 Teams</option>
                        <option value="5">5 Teams</option>
                        <option value="6">6 Teams</option>
                    </select>
                </div>
                <a href="https://chatgpt.com/" target="_blank" class="btn-gpt" style="padding: 8px 16px; border-radius: 4px; font-weight: bold;">
                    Open Custom GPT
                </a>
            </div>
            
            <div>
                <h3 style="margin-bottom: 10px; color:#aaa;">Team Names</h3>
                <div id="team-inputs" class="team-setup-grid">
                    </div>
            </div>
        </div>

        <div class="instructions">
            First row: <code>category,points,question,answer,type,media_url</code>
        </div>
        
        <textarea id="csv-input" placeholder="Paste CSV data here..."></textarea>
        
        <div class="btn-group">
            <button class="btn-primary" onclick="processCSV()">Build Grid</button>
            <button class="btn-secondary" onclick="fillExample()">Load Example</button>
        </div>
        <div id="error-msg" style="color: #e74c3c; margin-top: 10px; font-weight: bold; height: 20px;"></div>
    </div>

    <div id="game-view" class="hidden">
        <div class="top-bar">
            <div id="scoreboard"></div>
            <button class="btn-reset" onclick="resetGame()">Edit Board</button>
        </div>

        <div id="board-container">
            <div id="board"></div>
        </div>
    </div>

    <div id="question-modal" class="modal">
        <div class="modal-content">
            <button class="btn-close" onclick="handleWrongAnswer()">&times;</button>
            
            <div class="active-team-indicator" id="modal-team-indicator">Team 1</div>

            <div id="modal-media" class="media-container"></div>
            <div id="modal-question" class="q-text"></div>
            
            <div id="modal-answer" class="answer-box hidden"></div>

            <div class="modal-controls">
                <button id="btn-reveal" class="btn-primary" onclick="revealAnswer()">Reveal Answer</button>
                
                <div id="post-reveal-controls" class="hidden" style="display: flex; gap: 15px;">
                    <button id="btn-award" class="btn-award" onclick="awardPoints()">Correct (+0)</button>
                    <button class="btn-wrong" onclick="handleWrongAnswer()">Wrong (Next Team)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="winner-modal" class="modal">
        <div class="modal-content" style="background: transparent; border: none;">
            <div class="winner-text">WINNER!</div>
            <div id="winner-name" class="winner-name">Team Name</div>
            <button class="btn-secondary" style="margin-top: 40px;" onclick="closeWinnerModal()">Close</button>
        </div>
    </div>

    <script>
        // --- STATE ---
        let categories = []; // Array of { name: "Hist", questions: [] }
        let currentTile = null; 
        let currentQuestionPoints = 0;
        let totalTiles = 0;
        let usedTilesCount = 0;
        
        // Team State
        let teams = []; // { name: "Team 1", score: 0 }
        let activeTeamIndex = 0;

        // --- DOM ---
        const setupView = document.getElementById('setup-view');
        const gameView = document.getElementById('game-view');
        const csvInput = document.getElementById('csv-input');
        const boardDiv = document.getElementById('board');
        const scoreboardDiv = document.getElementById('scoreboard');
        const teamSelect = document.getElementById('team-count');
        const teamInputsDiv = document.getElementById('team-inputs');

        // Modal DOM
        const qModal = document.getElementById('question-modal');
        const modalQ = document.getElementById('modal-question');
        const modalA = document.getElementById('modal-answer');
        const modalMedia = document.getElementById('modal-media');
        const modalTeamInd = document.getElementById('modal-team-indicator');
        const btnReveal = document.getElementById('btn-reveal');
        const postRevealControls = document.getElementById('post-reveal-controls');
        const btnAward = document.getElementById('btn-award');

        // --- INITIALIZATION ---
        window.onload = updateTeamInputs; // Run once on load

        function updateTeamInputs() {
            const count = parseInt(teamSelect.value);
            teamInputsDiv.innerHTML = '';
            for(let i=1; i<=count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = `Team ${i}`;
                input.id = `team-name-${i}`;
                teamInputsDiv.appendChild(input);
            }
        }

        // --- CSV PROCESSING ---
        function processCSV() {
            let rawText = csvInput.value.trim();
            if (!rawText) return alert("Please paste CSV data.");

            // Strip Markdown
            const match = rawText.match(/^```(?:csv)?\s*([\s\S]*?)\s*```$/i);
            if (match) rawText = match[1].trim();

            Papa.parse(rawText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert(`CSV Error: ${results.errors[0].message}`);
                        return;
                    }
                    buildDataStructure(results.data);
                }
            });
        }

        function buildDataStructure(data) {
            const tempCats = {};
            data.forEach(row => {
                if (!row.category || !row.points || !row.question) return;
                const cat = row.category.trim();
                if (!tempCats[cat]) tempCats[cat] = [];
                
                tempCats[cat].push({
                    points: parseInt(row.points),
                    question: row.question,
                    answer: row.answer || "No answer",
                    type: (row.type || 'text').toLowerCase(),
                    media_url: row.media_url || ''
                });
            });

            // Convert map to array and sort questions
            categories = Object.keys(tempCats).map(name => {
                return {
                    name: name,
                    questions: tempCats[name].sort((a,b) => a.points - b.points)
                };
            });

            if(categories.length === 0) return alert("No valid data found.");

            initGame();
        }

        function initGame() {
            // Init Teams
            teams = [];
            const inputs = teamInputsDiv.querySelectorAll('input');
            inputs.forEach(inp => teams.push({ name: inp.value, score: 0 }));
            activeTeamIndex = 0;

            // Init Board Stats
            usedTilesCount = 0;
            totalTiles = categories.reduce((acc, cat) => acc + cat.questions.length, 0);

            renderScoreboard();
            renderBoardGrid();
            
            setupView.classList.add('hidden');
            gameView.classList.remove('hidden');
        }

        // --- RENDERING (GRID SYSTEM) ---
        function renderBoardGrid() {
            // Determine max rows needed (max questions in a category)
            let maxRows = 0;
            categories.forEach(c => maxRows = Math.max(maxRows, c.questions.length));

            // Set Grid CSS
            const colCount = categories.length;
            boardDiv.style.gridTemplateColumns = `repeat(${colCount}, 1fr)`;
            boardDiv.innerHTML = '';

            // 1. Render Headers (Row 1)
            categories.forEach(cat => {
                const header = document.createElement('div');
                header.className = 'cat-header';
                header.textContent = cat.name;
                boardDiv.appendChild(header);
            });

            // 2. Render Tiles (Row by Row)
            for (let i = 0; i < maxRows; i++) {
                categories.forEach(cat => {
                    const q = cat.questions[i];
                    if (q) {
                        const tile = document.createElement('button');
                        tile.className = 'tile';
                        tile.textContent = q.points;
                        tile.onclick = () => openQuestion(tile, q);
                        boardDiv.appendChild(tile);
                    } else {
                        // Empty slot to keep alignment
                        const empty = document.createElement('div');
                        boardDiv.appendChild(empty);
                    }
                });
            }
        }

        function renderScoreboard() {
            scoreboardDiv.innerHTML = '';
            teams.forEach((team, index) => {
                const div = document.createElement('div');
                div.className = `team-card ${index === activeTeamIndex ? 'active' : ''}`;
                div.innerHTML = `
                    <button class="btn-manual-add" onclick="manualScore(event, ${index})">+</button>
                    <div class="team-name">${team.name}</div>
                    <div class="team-points">${team.score}</div>
                `;
                div.onclick = (e) => {
                    if(e.target.tagName !== 'BUTTON') {
                        activeTeamIndex = index;
                        renderScoreboard();
                    }
                };
                scoreboardDiv.appendChild(div);
            });
        }

        function manualScore(e, teamIndex) {
            e.stopPropagation(); // prevent team switch
            const amount = prompt(`Add/Subtract points for ${teams[teamIndex].name}:`, "100");
            const val = parseInt(amount);
            if (!isNaN(val)) {
                teams[teamIndex].score += val;
                renderScoreboard();
            }
        }

        // --- GAMEPLAY ---
        function openQuestion(tile, qObj) {
            currentTile = tile;
            currentQuestionPoints = qObj.points;
            
            modalQ.textContent = qObj.question;
            modalA.textContent = qObj.answer;
            modalA.classList.add('hidden');
            
            modalMedia.innerHTML = '';
            if (qObj.type !== 'text' && qObj.media_url) {
                let el;
                if (qObj.type === 'image') el = document.createElement('img');
                else if (qObj.type === 'video') { el = document.createElement('video'); el.controls = true; }
                else if (qObj.type === 'audio') { el = document.createElement('audio'); el.controls = true; }
                
                if(el) { el.src = qObj.media_url; modalMedia.appendChild(el); }
            }

            btnReveal.classList.remove('hidden');
            postRevealControls.classList.add('hidden');
            
            updateModalTeamUI();
            qModal.classList.add('active');
        }

        function updateModalTeamUI() {
            const t = teams[activeTeamIndex];
            modalTeamInd.textContent = `${t.name} is answering`;
            modalTeamInd.style.borderColor = "#2ecc71"; // always green for active
        }

        function revealAnswer() {
            modalA.classList.remove('hidden');
            btnReveal.classList.add('hidden');
            postRevealControls.classList.remove('hidden');
            btnAward.textContent = `Correct (+${currentQuestionPoints})`;
        }

        function awardPoints() {
            teams[activeTeamIndex].score += currentQuestionPoints;
            finalizeTurn();
        }

        function handleWrongAnswer() {
            // Do not add points
            finalizeTurn();
        }

        function finalizeTurn() {
            // Stop media
            const vid = modalMedia.querySelector('video');
            if (vid) vid.pause();
            const aud = modalMedia.querySelector('audio');
            if (aud) aud.pause();

            qModal.classList.remove('active');
            
            if (currentTile && !currentTile.classList.contains('used')) {
                currentTile.classList.add('used');
                usedTilesCount++;
            }

            // Next team
            activeTeamIndex = (activeTeamIndex + 1) % teams.length;
            renderScoreboard();

            // Check Win
            if (usedTilesCount >= totalTiles) {
                setTimeout(declareWinner, 500);
            }
        }

        function declareWinner() {
            // Find max score
            let maxScore = -Infinity;
            teams.forEach(t => maxScore = Math.max(maxScore, t.score));
            const winners = teams.filter(t => t.score === maxScore).map(t => t.name);
            
            document.getElementById('winner-name').textContent = winners.join(' & ');
            document.getElementById('winner-modal').classList.add('active');
        }

        function closeWinnerModal() {
            document.getElementById('winner-modal').classList.remove('active');
        }

        function resetGame() {
            if(confirm("Exit to main menu?")) {
                gameView.classList.add('hidden');
                setupView.classList.remove('hidden');
            }
        }

        function fillExample() {
            csvInput.value = `category,points,question,answer,type,media_url
Science,100,Symbol for Gold,Au,text,
Science,200,Hardest substance,Diamond,text,
History,100,First US President,Washington,text,
History,200,Year WWII ended,1945,text,
Movies,100,Toy Story cowboy,Woody,text,
Movies,200,Titanic director,Cameron,text,`;
        }
    </script>
</body>
</html>
